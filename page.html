<!DOCTYPE html>
<html>

<head>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
    <!-- Bootstrap core CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.8/css/mdb.min.css" rel="stylesheet">

    <!-- JQuery -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.8/js/mdb.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://proofd-it.github.io/webapp/puck.js"></script>
    <script src="https://proofd-it.github.io/webapp/script.js"></script>

</head>

<body>
    <div class="container-fluid mt-2">

        <!--Grid row-->
        <div class="row">

            <!--Grid column-->
            <div class="col-md-12 mb-12">

                <h2 style="text-align:center; font-size:50px;">Overall Assessment: <strong><span id="assessment"><span></strong></h2>
                <div class="col-md-12 mb-12">
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <button id="btnSearch" class="btn btn-primary btn-md center-block" Style="width: 300px;font-size:40px;" OnClick="btnSearch_Click">Accept</button>
                            <button id="btnClear" class="btn btn-danger btn-md center-block" Style="width: 300px;font-size:40px;" OnClick="btnClear_Click">Reject</button>
                        </div>
                    </div>

                    <hr class="my-4">
                    <div id="main"></div>
                    <hr class="my-4">

                    <script>
                        //create visualisations
                        var records = [{
                                state: "outside",
                                timeStart: "Thu Aug 22 2019 19:01:14 ",
                                timeEnd: "Thu Aug 22 2019 19:06:30 ",
                                assessment: "ok",
                                data: [{
                                    y: 17,
                                    t: "Thu Aug 22 2019 19:01:14 "
                                }, {
                                    y: 13,
                                    t: "Thu Aug 22 2019 19:01:15 "
                                }, {
                                    y: 15,
                                    t: "Thu Aug 22 2019 19:01:16 "
                                }]
                            },
                            {
                                state: "fridge",
                                timeStart: "Thu Aug 22 2019 19:06:30 ",
                                timeEnd: "Thu Aug 22 2019 20:01:46 ",
                                assessment: "not ok",
                                data: [{
                                    y: 4,
                                    t: "Thu Aug 22 2019 20:01:15 "
                                }, {
                                    y: 4,
                                    t: "Thu Aug 22 2019 20:06:15 "
                                }, {
                                    y: 15,
                                    t: "Thu Aug 22 2019 20:11:15 "
                                }, {
                                    y: 15,
                                    t: "Thu Aug 22 2019 20:16:15 "
                                }, {
                                    y: 14.5,
                                    t: "Thu Aug 22 2019 20:21:15 "
                                }, {
                                    y: 15.5,
                                    t: "Thu Aug 22 2019 20:26:15 "
                                }]
                            },
                            {
                                state: "outside",
                                timeStart: "Thu Aug 22 2019 20:31:15 ",
                                timeEnd: "Thu Aug 22 2019 20:41:15  ",
                                assessment: "ok",
                                data: [{
                                    y: 17,
                                    t: "Thu Aug 22 2019 20:31:15 "
                                }, {
                                    y: 13,
                                    t: "Thu Aug 22 2019 20:36:15 "
                                }, {
                                    y: 15,
                                    t: "Thu Aug 22 2019 20:41:15 "
                                }]
                            },
                            {
                                state: "fridge",
                                timeStart: "Thu Aug 22 2019 20:46:15 ",
                                timeEnd: "Thu Aug 22 2019 21:06:15 ",
                                assessment: "not ok",
                                data: [{
                                    y: 13,
                                    t: "Thu Aug 22 20:51:15 "
                                }, {
                                    y: 13,
                                    t: "Thu Aug 22 2019 21:01:15 "
                                }, {
                                    y: 15,
                                    t: "Thu Aug 22 2019 21:06:15 "
                                }]
                            }
                        ];

                        var jsonRecords = JSON.stringify(records);

                        setTimeout(processRecords(jsonRecords), 1000);

                        function toHHMMSS(sec_num) {

                            let hours = Math.floor(sec_num / 3600);
                            let minutes = Math.floor((sec_num - (hours * 3600)) / 60);
                            let seconds = sec_num - (hours * 3600) - (minutes * 60);

                            if (hours < 10) {
                                hours = "0" + hours;
                            }
                            if (minutes < 10) {
                                minutes = "0" + minutes;
                            }
                            if (seconds < 10) {
                                seconds = "0" + seconds;
                            }
                            return hours + ':' + minutes + ':' + seconds;
                        }


                        function addChart(containerID, records) {

                            colors = [];
                            times = [];
                            for (i = 0; i < records.length; i++) {
                                times.push(records[i].t);

                                if (records[i].y > 5) {
                                    colors.push('#FF0000');
                                } else {
                                    colors.push('#000000');
                                }
                            }

                            console.log(times);

                            let ctx = document.getElementById(containerID).getContext('2d');
                            ctx.height = 200;
                            ctx.width = 200;
                            let myChart = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: times,
                                    datasets: [{
                                        label: 'temperature',
                                        data: records,
                                        backgroundColor: colors,
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    maintainAspectRatio: false,
                                    scales: {
                                        yAxes: [{
                                                ticks: {
                                                    beginAtZero: true,
                                                    fontSize: 20
                                                }
                                            }

                                        ],

                                        xAxes: [{
                                            type: 'time',
                                            distribution: 'linear',
                                            ticks: {
                                                fontSize: 20
                                            }
                                        }]

                                    },
                                    annotation: {
                                        annotations: [{
                                            type: 'line',
                                            mode: 'horizontal',
                                            scaleID: 'y-axis-0',
                                            value: 5,
                                            borderColor: 'rgb(75, 192, 192)',
                                            borderWidth: 4,
                                            label: {
                                                enabled: true,
                                                content: 'Maximum cold storage temperature',
                                                fontSize: 30
                                            }
                                        }],


                                    },
                                    legend: {
                                        labels: {
                                            // This more specific font property overrides the global property
                                            fontSize: 30
                                        }
                                    }
                                }
                            });






                        }


                        function processRecords(data) {

                            let overalAssessment = true;

                            let recordsArray = JSON.parse(data);
                            console.log(recordsArray);

                            let = explanationText = "no explanation";

                            let html = "";


                            for (i = 0; i < recordsArray.length; i++) {

                                let chartHTML = "";

                                let assesmentResult = "assessemnt missing";

                                if (recordsArray[i].assessment === "ok") {
                                    assesmentResult = '<span style="color:green">OK</span>'

                                    if (recordsArray[i].state == "outside") {
                                        explanationText = "Time allowed time of 15 minutes for the item to be outside a cooling facility has not been exceeded and the observed ambient temperature has not exceeded 25&deg;C";
                                    }

                                    if (recordsArray[i].state == "fridge") {
                                        explanationText = "The observed fridge temperature has not exceeded 5&deg;C in 3 consecutive readings";
                                    }

                                }

                                if (recordsArray[i].assessment === "not ok") {
                                    overalAssessment = false;
                                    assesmentResult = '<span style="color:red">NOT OK</span>'

                                    if (recordsArray[i].state == "outside") {
                                        explanationText = "Time allowed for the item to be outside a cooling facility has been exceeded or the observed ambient temperature has exceeded 5&deg;C";
                                    }

                                    if (recordsArray[i].state == "fridge") {
                                        explanationText = "The observed fridge temperature has exceeded 5&deg;C in at least 3 consecutive readings";
                                    }


                                    ///include chart as well
                                    chartHTML = `<canvas id="chart${i}" style="max-height:450px; " ></canvas>`;

                                }

                                let date = Date.parse(recordsArray[i].timeEnd) - Date.parse(recordsArray[i].timeStart);
                                console.log(explanationText);
                                html = html + `
  <div class="accordion" id="accordionExample">
  <div class="card z-depth-0 bordered">
    <div class="card-header" id="headingOne">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" style="font-size:2.5rem;" type="button" data-toggle="collapse" data-target="#collapse${i}"
          aria-expanded="true" aria-controls="collapse${i}">
          Stage:  ${recordsArray[i].state} <br>
          Start:  ${recordsArray[i].timeStart}  <br>
          Duration:  ${toHHMMSS(date/1000)} <br>
        </button>
        
        <p style="float:right;font-size:2.5rem;"> Assesment
        <br>
        
        ${assesmentResult}
        </p>
      </h5>
    </div>
    <div id="collapse${i}" class="collapse" aria-labelledby="headingOne"
      data-parent="#accordionExample">
      <div class="card-body"  >
      
     ${chartHTML}
      <p style="font-size:30px">${explanationText}</p>
     
      </div>
    </div>
  </div>
</div>
  `;


                            }


                            $(document).ready(function() {
                                var promise = new Promise((resolve, reject) => {
                                    Puck.modal(function() {
                                        receiveData();
                                        resolve();
                                    });
                                });
                                promise.then(_ => {
                                    let assessemntElement = document.getElementById("assessment")

                                    if (overalAssessment) {
                                        assessemntElement.innerHTML = "COMPLIANT";
                                    } else {
                                        assessemntElement.innerHTML = "NOT COMPLIANT";
                                    }
                                    document.getElementById("main").innerHTML = html;
                                    for (i = 0; i < recordsArray.length; i++) {
                                        if (recordsArray[i].assessment === "not ok") {
                                            addChart(`chart${i}`, recordsArray[i].data);
                                        }
                                    }
                                    console.log("fin");

                                });
                            });




                        }
                    </script>

                    <!--<button onclick="getRecords();">Get Data</button>--!>
</div>
</div>
</div>
</body>
</html>
